name: Release

on:
  release:
    types: [published]

jobs:
  upload-binaries:
    name: Upload Release Binaries
    runs-on: ubuntu-latest
    # Only run for version tags, not the 'latest' pre-release
    if: startsWith(github.event.release.tag_name, 'v') && github.event.release.tag_name != 'latest'
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run typecheck

      - name: Build all targets
        run: |
          mkdir -p dist
          bun build src/index.ts --compile --target=bun-darwin-arm64 --outfile=dist/paw-darwin-arm64
          bun build src/index.ts --compile --target=bun-darwin-x64 --outfile=dist/paw-darwin-x64
          bun build src/index.ts --compile --target=bun-linux-x64 --outfile=dist/paw-linux-x64
          bun build src/index.ts --compile --target=bun-linux-arm64 --outfile=dist/paw-linux-arm64

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'dist/paw-*'

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            dist/paw-darwin-arm64
            dist/paw-darwin-x64
            dist/paw-linux-x64
            dist/paw-linux-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: upload-binaries
    environment: action-runners
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: homebrew-tap

      - name: Get GitHub App user ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Download release binaries
        run: gh release download "$TAG" --repo "$REPO" --pattern 'paw-*' --dir assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
          REPO: ${{ github.repository }}

      - name: Compute SHA256 checksums
        id: sha
        run: |
          echo "darwin_arm64=$(sha256sum assets/paw-darwin-arm64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "darwin_x64=$(sha256sum assets/paw-darwin-x64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_arm64=$(sha256sum assets/paw-linux-arm64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_x64=$(sha256sum assets/paw-linux-x64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Extract version
        id: version
        run: echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
        env:
          TAG: ${{ github.event.release.tag_name }}

      - name: Checkout homebrew-tap
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/homebrew-tap
          token: ${{ steps.app-token.outputs.token }}

      - name: Update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          SHA_DARWIN_ARM64: ${{ steps.sha.outputs.darwin_arm64 }}
          SHA_DARWIN_X64: ${{ steps.sha.outputs.darwin_x64 }}
          SHA_LINUX_ARM64: ${{ steps.sha.outputs.linux_arm64 }}
          SHA_LINUX_X64: ${{ steps.sha.outputs.linux_x64 }}
        run: |
          cat > Formula/paw.rb << EOF
          class Paw < Formula
            desc "Personal dotfiles manager CLI"
            homepage "https://alexcatdad.github.io/paw/"
            license "MIT"
            version "${VERSION}"

            on_macos do
              on_arm do
                url "https://github.com/alexcatdad/paw/releases/download/v#{version}/paw-darwin-arm64"
                sha256 "${SHA_DARWIN_ARM64}"
              end

              on_intel do
                url "https://github.com/alexcatdad/paw/releases/download/v#{version}/paw-darwin-x64"
                sha256 "${SHA_DARWIN_X64}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/alexcatdad/paw/releases/download/v#{version}/paw-linux-arm64"
                sha256 "${SHA_LINUX_ARM64}"
              end

              on_intel do
                url "https://github.com/alexcatdad/paw/releases/download/v#{version}/paw-linux-x64"
                sha256 "${SHA_LINUX_X64}"
              end
            end

            def install
              binary = Dir["paw-*"].first || "paw"
              bin.install binary => "paw"
            end

            test do
              assert_match "paw", shell_output("#{bin}/paw --help")
            end
          end
          EOF

      - name: Commit and push
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git config user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'
          git add Formula/paw.rb
          git diff --staged --quiet || {
            git commit -m "chore: update paw to ${VERSION}"
            git push
          }
