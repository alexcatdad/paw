name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Lint & Type Check
  # ─────────────────────────────────────────────────────────────────────────────
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run typecheck

      - name: Check shell scripts
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          shellcheck install.sh

      - name: Validate YAML
        run: |
          for f in .github/workflows/*.yml; do
            echo "Checking $f"
            python3 -c "import yaml; yaml.safe_load(open('$f'))"
          done

  # ─────────────────────────────────────────────────────────────────────────────
  # Security Scan
  # ─────────────────────────────────────────────────────────────────────────────
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for secrets (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for personal info leaks
        run: ./scripts/security-check.sh

  # ─────────────────────────────────────────────────────────────────────────────
  # Test on macOS
  # ─────────────────────────────────────────────────────────────────────────────
  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build binary
        run: bun build src/index.ts --compile --outfile=dist/paw

      - name: Test CLI commands
        run: |
          ./dist/paw --version
          ./dist/paw --help

      - name: Upload macOS binary
        uses: actions/upload-artifact@v6
        with:
          name: paw-darwin-arm64
          path: dist/paw

  # ─────────────────────────────────────────────────────────────────────────────
  # Test on Linux
  # ─────────────────────────────────────────────────────────────────────────────
  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build binary
        run: bun build src/index.ts --compile --outfile=dist/paw

      - name: Test CLI commands
        run: |
          ./dist/paw --version
          ./dist/paw --help

      - name: Upload Linux binary
        uses: actions/upload-artifact@v6
        with:
          name: paw-linux-x64
          path: dist/paw

  # ─────────────────────────────────────────────────────────────────────────────
  # Build all platforms (only on main branch)
  # ─────────────────────────────────────────────────────────────────────────────
  build-all:
    name: Build All Platforms
    runs-on: ubuntu-latest
    needs: [lint, security, test-macos, test-linux]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build all targets
        run: |
          mkdir -p dist
          bun build src/index.ts --compile --target=bun-darwin-arm64 --outfile=dist/paw-darwin-arm64
          bun build src/index.ts --compile --target=bun-darwin-x64 --outfile=dist/paw-darwin-x64
          bun build src/index.ts --compile --target=bun-linux-x64 --outfile=dist/paw-linux-x64
          bun build src/index.ts --compile --target=bun-linux-arm64 --outfile=dist/paw-linux-arm64

      - name: Upload all binaries
        uses: actions/upload-artifact@v6
        with:
          name: paw-binaries
          path: dist/paw-*

  # ─────────────────────────────────────────────────────────────────────────────
  # Update latest release (only on main branch)
  # ─────────────────────────────────────────────────────────────────────────────
  update-latest:
    name: Update Latest Release
    runs-on: ubuntu-latest
    needs: [build-all]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Download binaries
        uses: actions/download-artifact@v7
        with:
          name: paw-binaries
          path: dist

      - name: Update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          prerelease: true
          files: |
            dist/paw-darwin-arm64
            dist/paw-darwin-x64
            dist/paw-linux-x64
            dist/paw-linux-arm64
          body: |
            ## Latest Build

            This is an automatically updated pre-release with the latest changes from `main`.

            **Install:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/alexcatdad/paw/main/install.sh | bash
            ```

            **Changes:** See [commit history](https://github.com/alexcatdad/paw/commits/main)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
